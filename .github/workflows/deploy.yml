name: Deploy to Firebase

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger from GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Create .env with secrets
      - name: Create functions .env
        run: |
          cat > functions/.env << EOF
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          EOF

      # Install function dependencies
      - name: Install function dependencies
        run: cd functions && npm install

      # Deploy everything to Firebase
      - name: Deploy to Firebase
        uses: w9jds/firebase-action@master
        with:
          args: deploy --force
        env:
          GCP_SA_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
